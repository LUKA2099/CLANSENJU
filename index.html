<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Gestione Spese Mensili</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      padding: 20px;
      max-width: 800px;
      margin: auto;
    }
    h1, h2 {
      text-align: center;
      color: #333;
    }
    section {
      background: #fff;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    input, button, select {
      padding: 8px;
      margin: 5px 0;
      width: 100%;
      box-sizing: border-box;
    }
    .spesa, .scadenza {
      border-bottom: 1px solid #ccc;
      padding: 5px 0;
    }
    .totale {
      font-weight: bold;
      color: green;
    }
    .negativo {
      color: red;
    }
  </style>
</head>
<body>

  <h1>ðŸ’¸ Gestione Spese Mensili</h1>
  <h2 id="meseCorrente"></h2>

  <section>
    <h2>Saldo Iniziale</h2>
    <input type="number" id="saldoIniziale" placeholder="Inserisci saldo iniziale">
    <button onclick="impostaSaldo()">Imposta saldo</button>
  </section>

  <section>
    <h2>Aggiungi al Saldo</h2>
    <input type="number" id="aggiuntaSaldo" placeholder="Importo da aggiungere">
    <button onclick="aggiungiAlSaldo()">Aggiungi</button>
  </section>

  <section>
    <h2>Saldo Attuale</h2>
    <p>Saldo attuale: <span id="saldoAttuale">â‚¬0.00</span></p>
  </section>

  <section>
    <h2>Aggiungi Spesa</h2>
    <input type="text" id="descrizioneSpesa" placeholder="Descrizione">
    <input type="number" id="importoSpesa" placeholder="Importo">
    <select id="personaSpesa">
      <option value="Gianluca">Gianluca</option>
      <option value="Valentina">Valentina</option>
    </select>
    <button onclick="aggiungiSpesa()">Aggiungi spesa</button>
    <div id="listaSpese"></div>
  </section>

  <section>
    <h2>Pagamenti in Scadenza</h2>
    <input type="text" id="descrizioneScadenza" placeholder="Descrizione pagamento">
    <input type="date" id="dataScadenza">
    <button onclick="aggiungiScadenza()">Aggiungi pagamento</button>
    <div id="listaScadenze"></div>
  </section>

  <section>
    <h2>Saldo Finale</h2>
    <p class="totale" id="saldoFinale">â‚¬0.00</p>
  </section>

  <script>
    const endpoint = "https://script.google.com/macros/s/AKfycbxgRch5NIj2Wu97ZIBY5ubZUB6fTFFK_YsFxeDVy0aegjLxfVcYqCWWEfp_qe3J94wt/exec";

    let saldo = 0;

    document.getElementById("meseCorrente").textContent = "Mese corrente: " + new Date().toLocaleString('it-IT', { month: 'long', year: 'numeric' });

    function aggiornaSaldo() {
      document.getElementById('saldoAttuale').textContent = `â‚¬${saldo.toFixed(2)}`;
      const finale = document.getElementById('saldoFinale');
      finale.textContent = `â‚¬${saldo.toFixed(2)}`;
      finale.className = saldo < 0 ? 'totale negativo' : 'totale';
    }

    function inviaASheet(foglio, dati) {
      fetch(`${endpoint}?sheet=${foglio}`, {
        method: "POST",
        body: JSON.stringify(dati),
        headers: { "Content-Type": "application/json" }
      });
    }

    function impostaSaldo() {
      const input = parseFloat(document.getElementById('saldoIniziale').value) || 0;
      saldo = input;
      aggiornaSaldo();
      inviaASheet("Saldo", { Data: new Date().toLocaleDateString(), Tipo: "Iniziale", Importo: input });
    }

    function aggiungiAlSaldo() {
      const input = parseFloat(document.getElementById('aggiuntaSaldo').value) || 0;
      saldo += input;
      aggiornaSaldo();
      inviaASheet("Saldo", { Data: new Date().toLocaleDateString(), Tipo: "Aggiunta", Importo: input });
      document.getElementById('aggiuntaSaldo').value = '';
    }

    function aggiungiSpesa() {
      const descrizione = document.getElementById('descrizioneSpesa').value;
      const importo = parseFloat(document.getElementById('importoSpesa').value);
      const persona = document.getElementById('personaSpesa').value;

      if (!descrizione || isNaN(importo)) return;

      saldo -= importo;
      aggiornaSaldo();

      const div = document.createElement('div');
      div.className = 'spesa';
      div.textContent = `${descrizione} (da ${persona}): -â‚¬${importo.toFixed(2)}`;
      document.getElementById('listaSpese').appendChild(div);

      inviaASheet("Spese", { Data: new Date().toLocaleDateString(), Descrizione: descrizione, Importo: importo, Persona: persona });

      document.getElementById('descrizioneSpesa').value = '';
      document.getElementById('importoSpesa').value = '';
    }

    function aggiungiScadenza() {
      const descrizione = document.getElementById('descrizioneScadenza').value;
      const data = document.getElementById('dataScadenza').value;
      if (!descrizione || !data) return;

      const div = document.createElement('div');
      div.className = 'scadenza';
      div.textContent = `${descrizione} â€“ Scade il ${data}`;
      document.getElementById('listaScadenze').appendChild(div);

      inviaASheet("Scadenze", { Data: new Date().toLocaleDateString(), Descrizione: descrizione, Scadenza: data });

      document.getElementById('descrizioneScadenza').value = '';
      document.getElementById('dataScadenza').value = '';
    }

    async function caricaSaldoDaGoogleSheet() {
      const resSaldo = await fetch(`${endpoint}?sheet=Saldo`);
      const datiSaldo = await resSaldo.json();
      const saldoTotale = datiSaldo.reduce((tot, r) => {
        const val = parseFloat(r.Importo) || 0;
        return r.Tipo === "Iniziale" || r.Tipo === "Aggiunta" ? tot + val : tot;
      }, 0);

      const resSpese = await fetch(`${endpoint}?sheet=Spese`);
      const datiSpese = await resSpese.json();
      const totaleSpese = datiSpese.reduce((tot, r) => tot + (parseFloat(r.Importo) || 0), 0);

      saldo = saldoTotale - totaleSpese;
      aggiornaSaldo();
    }

    // carica saldo da Google Sheet appena la pagina si apre
    window.onload = caricaSaldoDaGoogleSheet;
  </script>

</body>
</html>
